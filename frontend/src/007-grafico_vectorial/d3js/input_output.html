<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>3DJS | Salidas y entradas de datos</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
</head>

<style>
section {
    margin: 35px;
}
</style>

<body>

<section>

  <center><h1>Introducción</h1></center>

  <p>D3JS trabaja con un estilo de programación imperativo. Desde Javascript vamos manipulando los elementos del DOM. Por ejemplo: <code>d3.select("body").append("p");</code> añade un párrafo al cuerpo del documento. Fue creada por <a href="https://bost.ocks.org/mike/">Mike Bostok</a>, quien tiene <a href="https://bl.ocks.org/mbostock/3808218">interesantes artículos en su web</a> enseñando a utilizarla.</p>
  <br>
  <p>El truco de D3JS es pensar en los datos como de entrada, actualizacíón y salida. Imagina que tomamos dos arrays, uno de datos y otro de elementos del DOM. D3JS enlaza ambos y retorna 3 selecciones:</p>
  <ul>
    <li>La seleccion <code style="color:purple">ENTER</code> representa elementos "perdidos" (datos que han entrado) para los cuales quizas necesitamos crear elementos y añairlos al DOM.</li>
    <li>La selección <code style="color:purple">UPDATE</code> representa elementos existentes que quizás tengas tengas que modificar (por ejemplo, para reposicionarlos).</li>
    <li>La selección <code style="color:purple">EXIT</code> representa elementos sobrantes que quizás necesitamos eliminar del DOM.</li>
  </ul>

  <p>Luego vamos estableciendo intervalos de tiempo para ejecutar estas operaciones, lo que permite una visualización interactiva.</p>
  <li><a href="https://github.com/d3/d3/blob/master/API.md">Desde aquí</a> podemos acceder a la referencia de D3JS.</li>
  <hr>

  <!-- ======================================================================= -->

  <center><h1>Ejemplos</h1></center>

  
  <div class="row">
     
    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4 col-xl-4" id="aspecto">
      <h3> Aspecto </h3><hr>

      <div id="ejemplo1"></div><hr>

      <div id="ejemplo2"></div>
      <hr>

      <center><h4>Funcionamiento</h4></center>
        <p>La siguiente imagen es un gif, no es tu DOM, pero sirve para entender cómo está manipulando el DOM. Cada elemento <code>text</code> guarda una letra, las de color negro con la clase <code>update</code>. Cada letra está separada 32 píxeles.</p><br>
        <img src="assets/img/dom.gif" style="max-width: 103%">

      <hr>


       
    </div>


   <!-- ======================================================================= -->


    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4 col-xl-4" id="codigo">
      <h3> Código </h3><hr>

      <!-- Ejemplo 1 -->
        <xmp>var svg = d3.select("#ejemplo1")
  .append("svg")
  .attr("width", 175)
  .attr("height", 175);
var circle = svg.append("circle")
  .attr("cx", 25)
  .attr("cy", 25)
  .attr("r", 25)
  .style("fill", "purple");</xmp><hr>

<xmp>


<style>
text { font: bold 38px monospace; }
.enter { fill: #932; }
.update { fill: #333; }
</style>

<script>
var abecedario = "abcdefghijklmnñopqrstuvwxyz".split("");

var svg = d3.select("#ejemplo2")
           .append("svg")
           .attr("width", 800)
           .attr("height", 100)
           .attr("align", "center");
var g = svg.append("g");

function update(data){

    var text = g.selectAll("text")
                  .data(data);

    text.attr("class", "update");


    text.enter().append("text")
      .attr("class", "enter")
      .attr("x", function(d, i) { return i * 32 })
      .attr("dy", ".75em")
    .merge(text)
      .text(function(d) {return d; });

    text.exit().remove();
}

update(abecedario);

d3.interval(function() {
  update(d3.shuffle(abecedario)
      .slice(0, Math.floor(Math.random() * 27))
      .sort());  // En orden alfabético
}, 1200);

</script>

</xmp>

    </div>

    <!-- ======================================================================= -->   

    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4 col-xl-4" id="explicacion">
      <h3> Explicación </h3><hr>

      <!-- Ejemplo 1 -->
      <center><h4>Manipulando el DOM</h4></center>
      <ul>
        <li>Para seleccionar elementos del documento usamos la función <code>select</code> y escogemos elementos usando los <a href="https://developer.mozilla.org/es/docs/Web/CSS/Selectores_CSS">Selectores CSS</a>.</li>
        <li>Para añadir elementos al DOM la función <code>append</code>.</li>
        <li>Para establecerles atributos usamos la función <code>attr</code>.</li>
        <li>Para establecer estilo a los elementos usamos <code>style</code>.</li>
      </ul>
      <br><hr>

      <center><h4>Entrada, actualización y salida</h4></center>
      <ul>
        <li>El siguiente ejemplo está extraído de la <a href="https://bl.ocks.org/mbostock/3808218">web de Mike Bostok</a>.</li><br>
        <li>Establecemos estilos, la clase <code>enter</code> de color <span style="color:#932">rojo</span> y la clase <code>update</code> de color negro.</li>
        <br><br><br>
        <li>Creamos un array con todas las letras de abecedario, luego un contenedor svg donde guardaremos cada letra en etiquetas <code>text</code>. </li>
        <br>
        <li>El elemento <code>g</code> es un contenedor que engrupa a varios elementos. Las transformaciones aplicadas a él son realizadas sobre todos los elementos hijos. <a href="https://developer.mozilla.org/es/docs/Web/SVG/Element/g">Desde aquí</a> puedes consultar un ejemplo de su uso.</li>
        <br><code style="color:purple">UPDATE</code>
        <li>Seleccionamos todos los elementos <code>text</code> dentro del <code>svg</code> y le volcamos la información con la función <code>data</code>, la cual añade en el DOM a cada uno una nueva propiedad llamada <code>__data__,</code>, cuyo valor es un elemento del array.</li>
        <li>Aplicamos a todos los elementos la clase <code>update</code>(colorear de negro)</li>
        <code style="color:purple">ENTER</code>
        <li> Cuando aplicamos la función <code>data()</code> por segunda vez sobre un elemento <code>text</code>, su clase cambia de <code>enter</code> a <code>update</code>, así podemos interactuar con los elementos que acaban de entrar mediante la función <code>enter()</code>. Añadimos como atributo x una funcíón que toma un dato y un índice de cada elemento del array y lo multiplica por 32 (para separar letras). Esto se llama <a href="https://www.dashingd3js.com/using-data-bound-to-dom-elements">pasar funciones a los operadores</a>.</li>
        <code style="color:purple">EXIT</code>
        <li>Eliminamos los elementos antiguos que se encuentran en el DOM pero no en el array con la función <code>exit</code>.</li>
        <br>
        <li>Lanzamos el código desde aquí. Luego establecemos un intervalo de 1200 milisegundos para llamar a la función update, estableciendo un bucle.</li>
        <li><code>Math.random()</code> crea un número decimal aleatorio entre 0 y 1. <code>Math.floor()</code> redondea al entero más próximo. Ćon <code>slice</code> extraemos una parte del array con índices entre 0 y 27, el número de letras del abecedario español. Con sort ordenamos las letras por orden alfabético.</li>



        <br>
        <li><a href="https://github.com/d3/d3-array">Desde aquí</a> podemos consultar la documentación de las funciones <code>slice</code> y <code>shuffle</code>.</li>
        
      </ul><hr>


       
    </div>


  </div>

</section>

  
</body>

<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://d3js.org/d3.v4.min.js"></script>

<script>
// Ejemplo 1
var svg = d3.select("#ejemplo1")
  .append("svg")
  .attr("width", 175)
  .attr("height", 175);
var circle = svg.append("circle")
  .attr("cx", 25)
  .attr("cy", 25)
  .attr("r", 25)
  .style("fill", "purple");

</script>



<style>
/* Ejemplo 2 */
text {
  font: bold 38px monospace;
}

.enter {
  fill: #932;
}

.update {
  fill: #333;
}

</style>



<script>

var abecedario = "abcdefghijklmnñopqrstuvwxyz".split("");

var svg = d3.select("#ejemplo2")
           .append("svg")
           .attr("width", 800)
           .attr("height", 100)
           .attr("align", "center");
var g = svg.append("g");

function update(data){
    // DATA JOIN
    // Enlaza la nueva info con los antiguos elementos
    var text = g.selectAll("text")
                  .data(data);

    // UPDATE
    // Actualiza los antiguos elementos
    text.attr("class", "update");

    // ENTER
    // Crear nuevos elementos a necesidad.
    //
    // ENTER + UPDATE
    // Después de unir los elementos que han entrado 
    // con la selección actualizada, aplica operaciones
    // en ambos
    text.enter().append("text")
      .attr("class", "enter")
      .attr("x", function(d, i) { return i * 32 })
      .attr("dy", ".75em")
    .merge(text)
      .text(function(d) {return d; });

    // EXIT
    // Elimina antiguos elementos
    text.exit().remove();
}


// La disposición inicial
update(abecedario);

// Coge aleatoriamente una parte de las letras del abedecedario.
d3.interval(function() {
  update(d3.shuffle(abecedario)
      .slice(0, Math.floor(Math.random() * 27))
      .sort());  // En orden alfabético
}, 1200);

</script>

</html>